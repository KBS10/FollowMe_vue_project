<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Riding Google Map Version2</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://www.google.com/jsapi"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyClA27v6a4Gi1JAbsImTxXRwH-jDb5XDaw&callback=initMap&libraries=&v=weekly"
      defer
    ></script>
  </head>
  <body>
    <h1>경로 생성</h1>
    <h3>지도를 클릭하여 path 를 생성하세요.</h3>
    <!-- TODO 초기화 버튼 만들기 -->
    <button>초기화</button>
    <div id="map" style="height: 700px"></div>
    <div id="elevation_chart"></div>
  </body>
  <script>
    google.load("visualization", "1", { packages: ["columnchart"] });
    var path = [];
    var markers = [];
    var polyline = null;

    function initMap() {
      const pointImgs = {
        startPoint: {
          icon: {
            url: "./img/map/marker_start.png",
            scaledSize: new google.maps.Size(80, 80),
            anchor: new google.maps.Point(23, 80),
          },
        },
        endPoint: {
          icon: {
            url: "./img/map/marker_end.png",
            scaledSize: new google.maps.Size(80, 80),
            anchor: new google.maps.Point(23, 80),
          },
        },
        point: {
          icon: {
            url: "./img/map/point_blue.png",
            scaledSize: new google.maps.Size(30, 30),
            anchor: new google.maps.Point(13, 16),
          },
        },
      };

      const mapOptions = {
        zoom: 18.5,
        center: { lat: 35.89527, lng: 128.62256 },
        disableDefaultUI: true,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
        },
      };
      const map = new google.maps.Map(
        document.getElementById("map"),
        mapOptions,
      );
      const elevator = new google.maps.ElevationService();
      displayPathElevation(map, path, elevator);
      polyline = displayPolylineOnMap(map, path);

      map.addListener("click", (event) => {
        const clickedPosition = event.latLng.toJSON();
        path.push(clickedPosition);
        displayMapObject(map, markers, path, pointImgs, elevator);
      });
    }

    function initMapObject(markers) {
      markers.map((element) => {
        element.setMap(null);
      });
      markers.splice(0, markers.length);
      polyline.setMap(null);
    }

    function displayMapObject(map, markers, path, pointImgs, elevator) {
      initMapObject(markers);
      displayMarkerOnMap(map, window.path, markers, pointImgs, elevator);
      displayPathElevation(map, path, elevator);
      polyline = displayPolylineOnMap(map, window.path);
    }

    function displayMarkerOnMap(map, path, markers, pointImgs, elevator) {
      // path 를 순회하면서 마커를 생성
      for (index in path) {
        const pathLength = path.length;
        const { startPoint, endPoint, point } = pointImgs;
        let pointImg =
          index == 0 ? startPoint : index == pathLength - 1 ? endPoint : point;
        const newMarker = placeMarker(map, path[index], pointImg);
        markers.push(newMarker);
      }

      let eventMarkerIndex = 0;
      // marker 에 클릭 이벤트 추가
      markers.map((element) => {
        element.addListener("click", (event) => {
          const { lat, lng } = event.latLng.toJSON();

          window.path = path.filter((item) => {
            return !(item.lat == lat && item.lng == lng);
          });
          displayMapObject(map, markers, window.path, pointImgs, elevator);
        });

        element.addListener("dragstart", (event) => {
          const { lat, lng } = event.latLng.toJSON();
          for (index in path) {
            let isSamePosition =
              lat === path[index].lat && lng === path[index].lng;
            if (isSamePosition) {
              eventMarkerIndex = index;
              return;
            }
          }
        });

        element.addListener("dragend", (event) => {
          const position = event.latLng.toJSON();
          path[eventMarkerIndex] = position;
          displayMapObject(map, markers, path, pointImgs, elevator);
        });
      });
    }

    function displayPolylineOnMap(map, path, elevator) {
      const polylineOption = {
        path,
        strokeColor: "#4683EE",
        strokeOpacity: 0.8,
        strokeWeight: 10,
        map,
      };

      return new google.maps.Polyline(polylineOption);
    }

    function placeMarker(map, position, { label, icon }) {
      const markerOption = {
        position,
        map,
        label,
        icon,
        draggable: true,
        title: "마커를 이동하여, 경로를 재설정합니다.",
      };

      return new google.maps.Marker(markerOption);
    }

    function displayPathElevation(map, path, elevator) {
      if (path.length < 2) {
        const chartDiv = document.getElementById("elevation_chart");
        chartDiv.innerHTML =
          "<h2 style='text-align:center; line-height:100px'>지도에서 출발지와 도착지를 선택해주세요</h2>";
        return;
      }
      elevator.getElevationAlongPath(
        {
          path,
          samples: 256,
        },
        plotElevation,
      );
    }

    function plotElevation(elevations, status) {
      const chartDiv = document.getElementById("elevation_chart");

      if (status !== "OK") {
        // Show the error code inside the chartDiv.
        chartDiv.innerHTML =
          "Cannot show elevation: request failed because " + status;
        return;
      }
      const chart = new google.visualization.ColumnChart(chartDiv);
      const data = new google.visualization.DataTable();
      data.addColumn("string", "Sample");
      data.addColumn("number", "Elevation");

      for (let i = 0; i < elevations.length; i++) {
        data.addRow(["", elevations[i].elevation]);
      }
      // Draw the chart using the data within its DIV.
      chart.draw(data, {
        height: 150,
        legend: "none",
        titleY: "Elevation (m)",
      });
    }
  </script>
</html>